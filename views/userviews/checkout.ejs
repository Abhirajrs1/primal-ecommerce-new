<!DOCTYPE html>
<html>

<head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="/assets/images/favicon.png" type="">
    <title>PRIMAL</title>
    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <!-- font awesome style -->
    <link href="/assets/css/font-awesome.min.css" rel="stylesheet" />
    <!-- Custom styles for this template -->
    <link href="/assets/css/style.css" rel="stylesheet" />
    <!-- responsive style -->
    <link href="/assets/css/responsive.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>


    <script src="https://code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha384-e4700gt1d8iKdFzcdCebqu8A1gEJqj7UnGtA1a5jjg6cuZlLqen6U2ib/6CC5mc7"
        crossorigin="anonymous"></script>


</head>

<body>
    <!-- nav -->
    <header class="header_section">
        <div class="container">
            <nav class="navbar navbar-expand-lg custom_nav-container ">
                <a class="navbar-brand" href="index.html"><img style="height: 9rem;width: auto;" width="300"
                        src="/assets/images/logo.jpg" alt="#" /></a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class=""> </span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent" style="margin-top: 30px;">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/">Home <span class="sr-only"></span></a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/productlist">Products</a>
                        </li>


                        <div class="col-4" style="margin-left: 1%;">
                            <form action="/search_userproduct" method="post" class="d-flex align-items-center">
                                <input class="form-control me-2" type="search" placeholder="Search" id="search"
                                    name="search">
                                <div>
                                    <button
                                        style="background-color:black ;color: antiquewhite;padding: 7px;border-radius: 10px;margin-left: 2px;margin-bottom: 20px;">Search
                                    </button>
                                </div>
                            </form>
                        </div>
                        <%if(!user){%>
                            <li style="margin-left:50px;" class="nav-item">
                                <a class="nav-link" href="/login">Login</a>
                            </li>
                            <%}else{%>
                                <li class="nav-item">
                                    <a class="nav-link" href="/logout">Logout</a>
                                </li>
                                <%}%>



                                    <li style="margin-left: 10px;" class="nav-item">
                                        <a class="nav-link" href="/cart">
                                            <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"
                                                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                                viewBox="0 0 456.029 456.029"
                                                style="enable-background:new 0 0 456.029 456.029;" xml:space="preserve">
                                                <g>
                                                    <g>
                                                        <path
                                                            d="M345.6,338.862c-29.184,0-53.248,23.552-53.248,53.248c0,29.184,23.552,53.248,53.248,53.248
                                   c29.184,0,53.248-23.552,53.248-53.248C398.336,362.926,374.784,338.862,345.6,338.862z" />
                                                    </g>
                                                </g>
                                                <g>
                                                    <g>
                                                        <path d="M439.296,84.91c-1.024,0-2.56-0.512-4.096-0.512H112.64l-5.12-34.304C104.448,27.566,84.992,10.67,61.952,10.67H20.48
                                   C9.216,10.67,0,19.886,0,31.15c0,11.264,9.216,20.48,20.48,20.48h41.472c2.56,0,4.608,2.048,5.12,4.608l31.744,216.064
                                   c4.096,27.136,27.648,47.616,55.296,47.616h212.992c26.624,0,49.664-18.944,55.296-45.056l33.28-166.4
                                   C457.728,97.71,450.56,86.958,439.296,84.91z" />
                                                    </g>
                                                </g>
                                                <g>
                                                    <g>
                                                        <path
                                                            d="M215.04,389.55c-1.024-28.16-24.576-50.688-52.736-50.688c-29.696,1.536-52.224,26.112-51.2,55.296
                                   c1.024,28.16,24.064,50.688,52.224,50.688h1.024C193.536,443.31,216.576,418.734,215.04,389.55z" />
                                                    </g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                                <g>
                                                </g>
                                            </svg>
                                        </a>
                                    </li>





                                    <%if(user){%>
                                        <li class="nav-item">
                                            <a class="nav-link" href="/wishlist">
                                                <i class="fas fa-heart"></i>
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="/wallet">
                                                <i class="fas fa-wallet"></i>
                                            </a>
                                        </li>
                                        <div class="btn-group">

                                        </div>
                                        <%}%>

                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- cdmlinks -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round|Open+Sans">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">

    <!-- home corousals -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.2.1/owl.carousel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>





    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- checkout -->
    <br>


    <style>
        .address {
            background-color: aliceblue;
            border-radius: 10px;

            border: 2px solid #5675F0;
            color: #000;
            font-size: 12px;
            font-weight: 500px;
            text-emphasis: none;
            margin-bottom: 20px;
            width: 100px;
            margin-left: 100px;

        }

        .address-selection-card h5 {
            margin-top: 0;
        }

        .address-selection-card label {
            display: block;
            margin-bottom: 10px;
            margin-left: 20px;
        }

        .address-selection-card input[type="radio"] {
            margin-right: 10px;
        }

        a {
            margin-bottom: 20px;
        }


        .coupon {
            padding: 10px;
            text-align: center;
            position: relative;
            z-index: 3;
        }

        .coupon:before {
            content: '';
            display: block;
            width: 95%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            z-index: -1;
            background-color: #000;
            transform: scale(1.08);
        }

        .coupon:after {
            content: '';
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            z-index: -1;
            border: 3px dashed #fff;
        }

        .coupon-head {
            font-weight: 400;
            font-size: 1rem;
            color: #fff;
        }

        .coupon-price {
            font-size: 1em;
            font-weight: 600;
            color: yellow;
        }

        .coupon-fat-text {
            font-weight: 600;
            font-size: 20px;
            color: #fff;
        }

        @media (min-width: 576px) {
            .address-selection-card {
                flex-basis: 48%;
            }
        }

        @media (min-width: 768px) {
            .address-selection-card {
                flex-basis: 31%;
            }
        }

        @media (min-width: 992px) {
            .address-selection-card {
                flex-basis: 23%;
            }
        }

        @media (min-width: 1200px) {
            .address-selection-card {
                flex-basis: 18%;
            }
        }
    </style>

    <br>
    <!-- Checkout Start -->


    <h5 style="margin-left:125px; margin-right: 4%;" class="section-title  text-uppercase mb-3"><span class=" pr-3"
            style="color:black;">Choose Address</span></h5>

    <form class="pay-form">

        <% for(let i=0;i<address.length;i++){ %>
            <span class="p-4 rounded container-fluid" style="width: 50%;">

                <div class="address-selection-card address col-sm-4 col-md-2"
                    style="display: inline-block; margin-bottom: 20px; width: 50%;">
                    <input style="margin-left: 10px;" type="radio" name="address" id="addressid"
                        value="<%=address[i].id %>" <% if(i===0){ %> checked <% }%>>
                        <label style="display: inline-block; width: 100%;">
                            <h5 style="color: #000; font-style: oblique; font-weight: bolder;"> Address Number <%=i+1%>
                            </h5>
                            <div
                                style="font-family: 'Arial', sans-serif; margin-top: 20px; padding: 15px; border-radius: 10px;">
                                <p><b>Name:</b> <i>
                                        <%=address[i].name%>
                                    </i></p>
                                <p><b>House Address:</b> <i>
                                        <%=address[i].housenumber%>
                                    </i></p>
                                <p><b>Nearest Area:</b> <i>
                                        <%=address[i].area%>
                                    </i></p>
                                <p><b>City:</b> <i>
                                        <%=address[i].city%>
                                    </i></p>
                                <p><b>State:</b> <i>
                                        <%=address[i].state%>
                                    </i></p>
                                <p><b>Pin:</b> <i>
                                        <%=address[i].pincode%>
                                    </i></p>
                            </div>
                        </label>
                </div>

            </span>

            <% } %>
                <div class="form-group " style="margin-left:120px;margin-bottom: 60px;">
                    <button type="submit" class="btn btn-success">
                        <a href="/addaddress" style="color: white; text-decoration: none;">ADD ADDRESS</a>
                    </button>
                </div>




                <!--First Row started -->


                <div class="row" style="display: flex;">
                    <div class="col-md-12 fs-5 text-lg text-uppercase "
                        style="margin-left: 5%;display:flex;gap:4rem;flex-wrap:wrap;">

                        <div class="col-md-5">
                            <div
                                style="border:2px solid #C7C7C7;box-shadow: 5px 5px 10px; border-radius: 8px; padding: 20px;">
                                <h5 style="text-align: center;font-size: 20px;font-weight: 900;"
                                    class="section-title position-relative text-uppercase mb-3"><span
                                        class=" pr-3">Order
                                        Total</span></h5>
                                <div class=" p-30 mb-5">

                                    <div class="border-bottom">
                                        <h6 style="color: red;" id="msg"></h6>
                                        <h6 class="mb-3 fs-8"
                                            style="padding-left:0px;padding-top: 30px;padding-bottom: 30px;padding-right: 30px; font-size: 22px ;font-weight: 900px; font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;">
                                            Products</h6>
                                        <%let total=0%>
                                            <% for(let i=0;i<cart.length;i++){ %>
                                                <% total +=cart[i].productprice * cart[i].productquantity %>
                                                    <div class="d-flex justify-content-between">
                                                        <p style="font-weight: 700;margin-top: 10px;">
                                                            <%=cart[i].productname%> x <%=cart[i].productquantity%>
                                                        </p>
                                                        <p style="font-weight: 700;margin-top: 10px;">
                                                            <%=cart[i].productprice * cart[i].productquantity%>
                                                        </p>
                                                    </div>
                                                    <%}%>
                                    </div>
                                    <div class="border-bottom pt-3 pb-2">
                                        <div class="d-flex justify-content-between mb-3 text-uppercase">
                                            <p style="font-weight: 700;margin-top: 10px;">Subtotal</p>
                                            <input id="subTotal" name="name" value="<%=total%>" type="hidden">
                                            <h6 style="font-weight: 700;margin-top: 10px;">
                                                <%=total%>
                                            </h6>
                                        </div>

                                    </div>

                                    <div class="pt-2">
                                        <div class="d-flex justify-content-between mt-2"
                                            style="font-weight: 700;margin-top: 10px;">
                                            <h5>Coupon Discount</h5>
                                            <h5 style="font-weight: 700;margin-top: 10px;" id="couponDiscount">No Coupon
                                            </h5>
                                            <input id="last" type="hidden" value="<%=total%>" name="total">

                                        </div>
                                    </div>


                                    <div class="pt-2">
                                        <div class="d-flex justify-content-between mt-2"
                                            style="font-weight: 700;margin-top: 10px;">
                                            <h5>Total</h5>
                                            <h5 style="font-weight: 700;margin-top: 10px;" id="gT">Rs <%=total%>
                                            </h5>

                                            <input id="last" type="hidden" value="<%=total%>" name="total">

                                        </div>
                                    </div>

                                    <!-- payment options -->

                                    <hr>
                                    <div
                                        style="margin-bottom: 40px; height: 30px; text-align: center;background-color: #000;color: #ddd;font-weight: 700;font-family: Arial, Helvetica, sans-serif;width: auto;border-radius: 8px;">
                                        <h5 style="padding-top: 2px;"><span>Payment</span>
                                        </h5>
                                    </div>

                                    <div class=" p-30">
                                        <div class="d-flex justify-content-between align-items-center pe-5">
                                            <div class="form-group">
                                                <div class="custom-control custom-radio">
                                                    <input type="radio" class="custom-control-input " name="payment"
                                                        id="COD" value="COD">
                                                    <label class="custom-control-label " for="COD">COD</label>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <div class="custom-control custom-radio">
                                                    <input type="radio" class="custom-control-input" name="payment"
                                                        id="Online" value="Online">
                                                    <label class="custom-control-label " for="Online">Online
                                                        payment</label>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="custom-control custom-radio">
                                                    <input type="radio" class="custom-control-input" name="payment"
                                                        id="Wallet" value="Wallet">
                                                    <label class="custom-control-label " for="Wallet">Wallet</label>

                                                </div>
                                            </div>
                                        </div>

                                        <h6 style="font-weight: 700;margin-top: 10px;"> WALLET
                                            <%=wallet%>
                                        </h6>
                                        <button class="btn btn-block btn-primary font-weight-bold py-3"
                                            type="submit">Place
                                            Order
                                        </button>
                                    </div>

                                    <!--End payment options -->
                                </div>
                            </div>
                        </div>



                        <!-- First Row ended -->



                        <!-- Modal -->
                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                            aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="exampleModalLabel">Enter coupon code</h1>
                                    </div>
                                    <div class="modal-body">
                                        <form>
                                            <input type="text" name="couponCode" class="form-control"
                                                placeholder="Coupon Code">
                                            <input type="text" name="total" value="<%=total%>" hidden>

                                            <div class="modal-footer">
                                                <button type="button" id="modalClose" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">Close</button>
                                                <button type="button" onclick="applyCoupon()"
                                                    class="btn btn-primary">Apply
                                                    Coupon</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!--modal end-->

                        <!-- <div class="row"> -->
                        <div class="col-md-5">
                            <!-- coupon -->

                            <div style="margin-bottom:50px;">
                                <div
                                    style="text-align:center; padding-inline: 30px; border: 2px solid #C7C7C7;box-shadow: 5px 5px 10px; border-radius: 8px; ">
                                    <h6 style="padding-top:30px; padding-bottom:20px; color:#000;font-weight: 1900px;">
                                        <strong>COUPONS</strong>
                                    </h6>

                                    <div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <%coupons.forEach((coupons)=>{%>

                                                <div class="coupon">
                                                    <div class="coupon-head">
                                                        <%=coupons.couponname%>
                                                    </div>
                                                    <div class="coupon-price">
                                                        <%=coupons.coupondiscount%>% OFF
                                                    </div>
                                                    <div class="coupon-fat-text">
                                                        <%=coupons.couponcode%>
                                                    </div>
                                                </div>

                                                <%})%>
                                        </div>
                                        <div>
                                            <button id="coupon"
                                                style="margin-left:0px;margin-top:30px;margin-bottom:30px;"
                                                type="button" class="btn btn-success" data-bs-toggle="modal"
                                                data-bs-target="#exampleModal">
                                                Apply coupon
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                </div>
                <hr>
    </form>
    <div id="customNotification" class="custom-notification" style="display: none;"></div>

    <br>




    <!--model start-->

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!--model end-->

    <script>

        function applyCoupon() {


            document.getElementById('modalClose').click()

            console.log(document.getElementsByName('total')[0].value)
            const total = document.getElementsByName('total')[0].value
            const coupon = document.getElementsByName('couponCode')[0].value
            fetch('/couponImplement', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ couponCode: coupon, total: total }),

            })
                .then(res => res.json())
                .then(data => {
                    const notification = document.getElementById('customNotification')
                    if (data.success) {
                        console.log('data success')
                        console.log(data.discountedTotal)
                        document.getElementById('couponDiscount').innerText = `-${Number(total) - Number(data.discountedTotal)}`
                        document.getElementById('gT').innerText = `Rs.${data.discountedTotal}`

                        notification.textContent = "COUPON ADDED SUCCESSFULLY";
                        notification.style.backgroundColor = '#28a745';
                        notification.style.display = 'block';
                    } else {
                        notification.textContent = "COUPON NOT ADDED";
                        notification.style.backgroundColor = '#dc3545';
                        notification.style.display = 'block';
                    }

                })
                .catch(error => {
                    console.log(error);
                    alert('Please try again; some error occurred.');
                });
        }

    </script>


    <script>
        $(document).ready(function () {
            $('.pay-form').submit(function (e) {
                e.preventDefault();

                var formData = $('.pay-form').serialize();
                $.ajax({
                    url: "/checkout",
                    type: "POST",
                    data: formData,
                    success: function (res) {
                        if (res.success) {
                            if (res.paymentmethod === 'COD') {
                                window.location.href = '/ordersuccess';
                            } else if (res.paymentmethod === 'Online') {
                                var options = {
                                    "key": "" + res.key_id + "",
                                    "amount": "" + res.amount + "",
                                    "currency": "INR",
                                    "name": "" + "PRIMAL" + "",
                                    "image": "https://dummyimage.com/600x400/000/fff",
                                    "order_id": "" + res.order_id + "",
                                    "handler": function (response) {
                                        $.ajax({
                                            url: "/verifyorder",
                                            type: "POST",
                                            contentType: "application/json",
                                            data: JSON.stringify({ data: res.data }),
                                            success: function (response) {
                                                if (response.success) {
                                                    console.log("Success", response);
                                                    window.location.href = '/ordersuccess';
                                                    alert(response.msg)
                                                } else {
                                                    console.log("failed.....", response);

                                                    alert("payment failed")
                                                }
                                            }
                                        })
                                    },
                                    "prefill": {
                                        "contact": "" + res.contact + "",
                                        "name": "" + res.name + "",
                                        "email": "" + res.email + ""
                                    },
                                    "notes": {
                                        "description": "" + res.description + ""
                                    },
                                    "theme": {
                                        "color": "#2300a3"
                                    }
                                };
                                var razorpayObject = new Razorpay(options);
                                razorpayObject.on('payment.failed', function (response) {
                                    alert("Payment Failed");
                                });
                                razorpayObject.open();
                            } else if (res.paymentmethod === "Wallet") {
                                window.location.href = '/ordersuccess';
                            }
                        }
                        else {
                            alert(res.msg);
                            console.log(res.msg);
                        }
                    }
                });

            });
        });

    </script>

    <%- include ('footer') %>